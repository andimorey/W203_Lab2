---
title: "Lab 2"
author: "Srishti Mehra, Andi Morey Peterson, and David Djambazov"
date: "11/14/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

  A common recommendation from doctors, scientists, and politicians is to wear face masks or other facial coverings to combat the spread of COVID-19. The World Health Organization states: "Masks are a key measure to suppress transmission and save lives. Masks reduce potential exposure risk from an infected person whether they have symptoms or not. People wearing masks are protected from getting infected. Masks also prevent onward transmission when worn by a person who is infected." Because we have not actually performed a controlled study/experiment, we want to build an descriptive model with data available about the current pandemic. 

Many states have issues mandates for their citizens to wear masks in public and additionally, many states have issues mandates for employees who interact with the public to wear masks.  Now that cases have surged in the United States, we ask: *Do state-wide facemask mandates correlate with the reduction in the amount of deaths in that state?* 

Because these mandates and other variables occur in a different times during the nine-month period, and the states were affected by the virus in different times as well, we will operationalize the variable "deaths" as the *Death Rate per 100,000  in the past 7 days* (ending Oct. 30th). Total deaths is inappropriate, as the population per state varies widely, skewing the data in largely populated states.  The total death rate per 100,000 is also inappropriate, as many states had large first waves in the beginning of the year which will skew the current state of the pandemic.  Using the current data (the past 7 days) will give a good analysis if the mandates are working *currently*.

We will operationalize "mandates" in two ways, as TRUE/FALSE indicators.  One will be if the state mandates for their citizens to wear masks in public the other is if the states have issued mandates for employees who interact with the public to wear masks.

As we move through the model, we will do some descriptive analysis on other variables that may interact with the main question.  These variables include: population density, racial diversity, political leanings, mobility, etc.  We will analyze each of these variables to come up with a final model to determine if and how much face masks are currently reducing death rates of citizens due to COVID-19. 

## Import the data

```{r read data, message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(openxlsx)
library(stargazer)
library(lmtest)
library(sandwich)
library(patchwork)
library(corrplot)
```

*can we remove and add the next portion instead?*
```{r}
covid_wb <- createWorkbook()
addWorksheet(covid_wb, "Covid-19")
raw_covid_data = read_excel("covid-19.xlsx", sheet = "Covid-19")
writeData(covid_wb, sheet = 1, x = raw_covid_data, startCol = 1, startRow = 0, colNames = TRUE)
saveWorkbook(covid_wb, "COVID_CLEAN.xlsx", overwrite = TRUE)
covid_data = read_excel("COVID_CLEAN.xlsx", sheet = 1)
file.remove("COVID_CLEAN.xlsx")


raw_covid_policy_data = read_excel("COVID-19 US state policy database (CUSP).xlsx",
                                   sheet = "Face Masks", range = "A1:J52")
covid_data <- left_join ( covid_data, raw_covid_policy_data, by=c("State"))

```

```{r}
covid_raw_data<-read.csv("covid-19.csv",skip=1)
covid_masks_policies_data<-read.csv("covid policies masks.csv")

covid_data<-left_join(
  covid_raw_data,
  covid_masks_policies_data)
```


```{r}
covid_data <- covid_data  %>% 
  rename(
      death_rate_in_last_7 = "Death.Rate.per.100K.in.Last.7.Days",
      mask_for_all_mandated_on = 'Mandate.face.mask.use.by.all.individuals.in.public.spaces',
      mask_for_all_end = 'State.ended.statewide.mask.use.by.individuals.in.public.spaces',
      mask_enforced_by_fines = 'Face.mask.mandate.enforced.by.fines',
      mask_enforced_by_charge = 'Face.mask.mandate.enforced.by.criminal.charge.citation',
      no_legal_mask_enforcement = 'No.legal.enforcement.of.face.mask.mandate',
      mask_for_public_facing_employee_mandated_on = 'Mandate.face.mask.use.by.employees.in.public.facing.businesses',
      population_density = 'Population.density.per.square.miles',
      stay_at_home_begin = 'Stay.at.home..shelter.in.place',
      stay_at_home_end = 'End.stay.at.home.shelter.in.place',
      retail_mobility_change ='Retail...recreation',
      grocery_pharm_mobility_change='Grocery...pharmacy',
      parks_mobility_change='Parks',
      transit_mobility_change = 'Transit.stations',
      workplaces_mobility_change = 'Workplaces',
      residential_mobility_change = 'Residential',
      white_percent = 'White...of.Total.Population',
      x65='X65.'
      )

covid_data$repgov <- grepl("(R)",covid_data$Governor)

```

# Initial Exploratory Data Analysis (EDA)

First, we want to take a look at the first variable we want to describe *Death Rate per 100K in the Last 7 Days*

```{r Death Rate EDA}
#make numeric
#covid_data$death_rate_per_100k_last_7 <- as.numeric(covid_data$death_rate_in_last_7)

hist(covid_data$death_rate_in_last_7, breaks = 15,
     main = "Histogram of Death Rates Per 100k in the Last 7 Days")
```

The distribution for "death rate" is skewed to the left. -- *Need more discussion here*

```{r State mandated mask for all EDA}
covid_data$mask_mandate_all <- ifelse(or(covid_data$mask_for_all_mandated_on == 0,                               covid_data$mask_for_all_end != 0), FALSE, TRUE)

covid_data %>% 
  ggplot(aes(x = mask_mandate_all, y = death_rate_in_last_7)) + 
  geom_boxplot() +   
  labs(
    title = 'Separation in last 7-day death rate by mask mandate', 
    x = 'Mandate face mask use by all in public', 
    y = 'Death Rate per 100k in Last 7 Days'
  )
```

# Model 1

Our first model will use the variables we looked at in the initial EDA.

$$death\_rate = \beta_0 + \beta_1 mandate + w \tag{1}$$
```{r Model 1}
model1 <- lm(death_rate_in_last_7 ~ mask_mandate_all, data = covid_data)
coeftest(model1, vcov = vcovHC)
```

Here we can see the coefficient of the mask_mandates is significant, but not highly, with the p-value less than 0.01.  Practically speaking, it says that having a face mask mandate for all is associated with a reduction of 0.21 deaths per 100k people per 7 days, or 2.1 deaths per 1 million people per 7 days.

```{r Model 1 Residuals}
hist(model1$residuals, breaks = 10, main = "Residuals from Linear Model 1 Predicting Death Rate") # Histogram of the Residuals
plot(model1, which=2) # QQ Plot of Residuals
#plot(model1, which=3) # Heteroskedasticity (looking for a straight line)
#plot(model1, which=5) # Cook's distance
```

When we plot the residuals of our first model, we can see that it isn't quite normal, with one particular state (North Dakota) having a residual above 1.

### 3. Limitations of your Model 

As a team, evaluate all of the CLM assumptions that must hold for your models. However, do not report an exhaustive examination all 5 CLM assumption. Instead, bring forward only those assumptions that you think pose significant problems for your analysis. For each problem that you identify, describe the statistical consequences. If you are able to identify any strategies to mitigate the consequences, explain these strategies. 

Note that you may need to change your model specifications in response to violations of the CLM.

1. IID
2. Linear Conditional Expectation
3. No perfect Colinearity
4. 
5.

### 4. A Regression Table

You should display all of your model specifications in a regression table, using a package like [`stargazer`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf) to format your output.  It should be easy for the reader to find the coefficients that represent key effects near the top of the regression table, and scan horizontally to see how they change from specification to specification.  Make sure that you display the most appropriate standard errors in your table, along with significance stars.

In your text, comment on both *statistical significance and practical significance*.  You may want to include statistical tests besides the standard t-tests for regression coefficients.

### 5. Discussion of Omitted Variables

If your team has chosen an explanatory (i.e. causal) question to evaluate, then identify what you think are the 5 most important *omitted variables* that bias the coefficients you care about.  For each variable, you should *reason about the direction of bias* caused by omitting this variable.  If you can argue whether the bias is large or small, that is even better.  State whether you have any variables available that may proxy (even imperfectly) for the omitted variable. Pay particular attention to whether each omitted variable bias is *towards zero or away from zero*.  You will use this information to judge whether the effects you find are likely to be real, or whether they might be entirely an artifact of omitted variable bias.

### 6. Conclusion

Make sure that you end your report with a discussion that distills key-takeaways from your estimates, addresses your research question, and draws attention to larger contexts.
